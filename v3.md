# Mitigating Docker Hub Rate Limitations with Registry Proxies: A Terraform Implementation Guide

## Situation üìä

In early 2025, Docker Hub announced a significant policy change: free users would be limited to 10 image pulls per hour starting April 1st. This represented a substantial constraint for development and production environments worldwide.

Concurrently, Upbound implemented a policy restricting free users to pulling only the latest Crossplane package versions as of March 25th, thereby limiting access to specific older versions that many enterprise workflows depend upon.

For our Kubernetes-based infrastructure environments with frequent scaling operations and spot instance usage, these policy implementations presented considerable operational challenges. Our analysis indicated that clients would exceed these limitations almost immediately during standard operations:

- A cluster with 20 nodes requiring 5 images each = 100 pulls
- Node replacements resulting from spot instance recycling = additional dozens of pulls hourly
- CI/CD pipeline test executions = further pulls against the established quota

While Docker Hub had not yet enforced their policy, it appeared to be an imminent change that could potentially disrupt critical infrastructure services.

## Task üéØ

We identified several critical requirements that needed to be addressed:

1. Implement a solution to circumvent the newly imposed rate limitations from Docker Hub and Upbound
2. Ensure uninterrupted access to specific Crossplane package versions
3. Enhance resilience against external registry service disruptions
4. Develop a solution compatible with multi-cloud environments

Any proposed solution needed to maintain transparency to client applications and minimize operational overhead for our infrastructure teams.

## Action üõ†Ô∏è

We architected a solution utilizing registry proxies across three platforms to cache both Docker images and Crossplane packages:

### 1. AWS ECR Pull-Through Cache Implementation

Amazon ECR's pull-through cache functionality was configured to automatically retrieve and store images from upstream registries upon initial request:

```terraform
# Initialize a secret to store Docker Hub authentication credentials
resource "aws_secretsmanager_secret" "docker_hub_creds" {
  name = "ecr-pullthroughcache/docker-hub"
}

# Store the Docker Hub authentication parameters
resource "aws_secretsmanager_secret_version" "docker_hub_creds_version" {
  secret_id     = aws_secretsmanager_secret.docker_hub_creds.id
  secret_string = jsonencode({
    username    = var.docker_hub_username
    accessToken = var.docker_hub_access_token
  })
}

# Establish the pull-through cache configuration
resource "aws_ecr_pull_through_cache_rule" "docker_hub" {
  ecr_repository_prefix = "docker-hub"
  upstream_registry_url = "registry-1.docker.io"
  credential_arn        = aws_secretsmanager_secret.docker_hub_creds.arn
}
```

### 2. Google Artifact Registry Remote Repository Configuration

We implemented Google Cloud's Artifact Registry to establish remote repositories that function as proxies for Docker Hub:

```terraform
# Create a remote repository configuration in Google Artifact Registry
resource "google_artifact_registry_repository" "docker_hub_proxy" {
  location      = var.region
  repository_id = "docker-hub-proxy"
  format        = "DOCKER"
  mode          = "REMOTE_REPOSITORY"

  # Define the remote repository configuration for Docker Hub
  remote_repository_config {
    description = "Docker Hub proxy repository"
    docker_repository {
      public_repository = "DOCKER_HUB"
    }
    # Configure Docker Hub authentication credentials
    upstream_credentials {
      username               = var.docker_hub_username
      password_secret_version = google_secret_manager_secret.docker_hub_token.id
    }
  }
}
```

### 3. Harbor Registry Deployment

For on-premises environments, we deployed Harbor with proxy cache projects configured for both Docker Hub and Upbound registries (managed through Helm chart value configurations).

### 4. Kubernetes Manifest Updates

We modified our deployment templates to reference container images through our established proxies:

**AWS ECR reference format:**

```
account-id.dkr.ecr.region.amazonaws.com/docker-hub/nginx:latest
```

**Google Artifact Registry reference format:**

```
region-docker.pkg.dev/project-id/docker-hub-proxy/nginx:latest
```

**Harbor reference format:**

```
harbor.internal.example.com/dockerhub-proxy/nginx:latest
```

For Crossplane packages, we established comparable proxy configurations and updated the package references accordingly.

## Results ‚úÖ

Our registry proxy implementation delivered several significant operational benefits:

1. **Rate limitation mitigation** - Kubernetes clusters now retrieve all container images through our proxy infrastructure, registering as a single pull against Docker Hub's quota regardless of the number of nodes requiring the image.

2. **Version accessibility preservation** - We maintained access to all previously utilized Crossplane package versions, allowing for more controlled and predictable upgrade processes.

3. **Enhanced service resilience** - During Docker Hub service interruptions (which have occurred multiple times this year), our infrastructure continues to operate without disruption.

4. **Performance optimization** - We observed a 30-40% reduction in container initialization times due to image retrieval from local proxy repositories.

5. **Improved governance** - We gained enhanced visibility into container image utilization patterns across our managed environments.

The implementation required initial configuration effort across our multi-cloud infrastructure, but has substantially improved operational reliability by eliminating external registry dependencies and rate limitations.

An additional unexpected benefit emerged: the ability to pre-cache critical service images, further enhancing reliability during scaling events and reducing service initialization latency.

---

_This article was prepared by the Platform Engineering team at Entigo, specialists in designing and implementing resilient infrastructure solutions for enterprise applications._
